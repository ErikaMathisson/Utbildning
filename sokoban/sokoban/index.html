<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Sokoban</title>
  <meta name="description" content="The Sokoban Game">
  <meta name="author" content="PHP Class">

  <link rel="stylesheet" href="css/style.css">

</head>

<body onkeyup="handleKey(event)">
	<h1>Sokoban</h1>
	<div>
		<h3>Steps: <span id="spnStepsCount">0</span></h3>
	</div>
	
	<input type="text" id="txtUsername" placeholder="Your Name Here" />
	<button onclick="printBoard()">Print Board</button>
	
	<table id="tblBoard"></table>

<script>

var WALL 	= "WALL";
var FLOOR 	= "FLOOR";
var TARGET 	= "TARGET";

var GAMER 	= "GAMER";
var BOX 	= "BOX";

var gGamerPos = {i: 2, j:9};

var gBoard = buildBoard();

//var obj = {name: "Moshe", age: 23};
//console.log(obj);


function  buildBoard() {

	// Create the Matrix
	var board = new Array(10);
	for (var i=0; i<board.length; i++) {
		board[i] = new Array(12);
	}

	// Put FLOOR everywhere and WALL at edges
	for (var i=0; i<board.length; i++) {
		for (var j=0; j<board[0].length; j++) {
			var cell = {type: FLOOR, gameElement: null};
			// if at edge
			if (i == 0 || i == board.length-1 || j == 0 || j == board[0].length-1) {
				cell.type = WALL;
				
			}
			board[i][j] = cell;
		}
	}
	// Put some Targets
	board[3][7].type = TARGET;
	board[5][7].type = TARGET;
	// Place the gamer
	board[gGamerPos.i][gGamerPos.j].gameElement = GAMER;

	// Place the Boxes
	board[3][8].gameElement = BOX;
	board[7][4].gameElement = BOX;

	console.log(board);
	return board;
}

function printBoard() {

	var tblBoard = document.getElementById('tblBoard');
	var strHTML = ''; 
	for (var i=0; i<gBoard.length; i++) {
		strHTML += "<tr>";
		for (var j=0; j<gBoard[0].length; j++) {
			var currCell = gBoard[i][j];
			var cellClass;
			if (currCell.type == FLOOR) {
				cellClass = "floor";				
			} else if (currCell.type == WALL) {
				cellClass = "wall";
			} else if (currCell.type == TARGET) {
				cellClass = "target";
			}
			strHTML += "<td class='cell " + cellClass + "'  onclick='handleClick("+i+","+j+")' >";

			if (currCell.gameElement == GAMER) {
				strHTML += "<img src='imgs/gamer.png'>";
			} else if (currCell.gameElement == BOX) {
					strHTML += "<img src='imgs/box.png'>";
			}
			
			strHTML += "</td>";
		}
		strHTML += "</tr>";
	}

	tblBoard.innerHTML = strHTML;
}

function handleClick(i, j) {
	var iDiff = i - gGamerPos.i;
	var jDiff = j - gGamerPos.j;
	var iAbsDiff = Math.abs(i - gGamerPos.i);
	var jAbsDiff = Math.abs(j - gGamerPos.j);

	// If the clicked Cell is one of the four allowed
	if ((iAbsDiff == 1 && jAbsDiff == 0) || (jAbsDiff == 1 && iAbsDiff == 0)) {

		if (gBoard[i][j].type != WALL) {
			//console.log("Moving");
			
			var canMove = true;
			
			if (gBoard[i][j].gameElement == BOX) {

				// In the next pos, if there is no WALL, and also no game element
				if (gBoard[i+iDiff][j+jDiff].type != WALL && gBoard[i+iDiff][j+jDiff].gameElement == null) {
					// MOVE THE BOX
					gBoard[i][j].gameElement = null;
					gBoard[i+iDiff][j+jDiff].gameElement = BOX;
				} else {
					// Cant move - there is a WALL behind BOX!
					console.log("WALL Behind BOX");
					canMove = false;
				}
			}
			
			if (canMove) {
				// MOVING
				gBoard[gGamerPos.i][gGamerPos.j].gameElement = null;
				gGamerPos.i = i;
				gGamerPos.j = j;
				gBoard[gGamerPos.i][gGamerPos.j].gameElement = GAMER;
	
				// Update steps count
				var spnStepsCount = document.getElementById('spnStepsCount');
				spnStepsCount.innerHTML++;

				printBoard();
				checkVictory();
							
			}
			
		}
		
	} // else console.log("TOO FAR", iAbsDiff, jAbsDiff);
	
	
}

function  checkVictory() {
	var isVictory = true;
	for (var i=0; i<gBoard.length; i++) {
		for (var j=0; j<gBoard[0].length; j++) {
			var currCell = gBoard[i][j];
			if (currCell.type == TARGET && currCell.gameElement != BOX ) isVictory = false;
		}
	}	

	if (isVictory) alert("Victorious!");
	
}


function handleKey(event) {
	//console.log(event.keyCode, event.keyIdentifier	 );

	var i = gGamerPos.i;
	var j = gGamerPos.j;
	 
	
	switch (event.keyCode) {
	case 37:
		handleClick(i, j-1);
		break;
	case 39:
		handleClick(i, j+1);
		break;
	case 38:
		handleClick(i-1, j);
		break;
	case 40:
		handleClick(i+1, j);
		break;

	}
	
}

</script>


  <script src="js/scripts.js"></script>
</body>
</html>